name: 123OpenWrt Auto Build

on:
  workflow_dispatch:
    inputs:
      SOURCE:
        description: "é€‰æ‹©æºç "
        required: true
        default: "lean"
        type: choice
        options:
          - lean
          - immortalwrt
          - official
      SSH:
        description: "æ˜¯å¦å¯ç”¨ SSH è°ƒè¯•ï¼ˆyes / noï¼‰"
        required: false
        default: "no"
  schedule:
    - cron: "0 0 1 * *"   # æ¯æœˆ1å· UTC 0ç‚¹

env:
  TZ: Asia/Shanghai
  REPO_URL_LEAN: https://github.com/coolsnowwolf/lede
  REPO_URL_IMMORTAL: https://github.com/immortalwrt/immortalwrt
  REPO_URL_OFFICIAL: https://github.com/openwrt/openwrt
  REPO_BRANCH: master

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆè§£å†³ç©ºé—´ä¸è¶³ï¼‰
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo apt clean
        df -h

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev \
          libz-dev patch python3 python3-distutils unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 \
          subversion flex uglifyjs gcc-multilib g++-multilib p7zip p7zip-full msmtp curl wget \
          rsync qemu-utils ccache

    - name: å…‹éš†æºç 
      run: |
        case "${{ github.event.inputs.SOURCE }}" in
          lean) URL=${REPO_URL_LEAN} ;;
          immortalwrt) URL=${REPO_URL_IMMORTAL} ;;
          official) URL=${REPO_URL_OFFICIAL} ;;
        esac
        git clone --depth 1 $URL -b $REPO_BRANCH openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a


    - name: Apply config
      env:
        CONFIG_FILE: '${{ github.event.inputs.target }}.config'
      run: |
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config


    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ï¼ˆå¯é€‰ scripts/*.shï¼‰
      run: |
        chmod +x scripts/*.sh 2>/dev/null || true
        for i in scripts/*.sh; do [ -e "$i" ] && $i; done || true

    - name: è‡ªå®šä¹‰è„šæœ¬åé‡æ–° feeds update & install
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: SSH Debug
      if: github.event.inputs.SSH == 'yes'
      uses: mxschmitt/action-tmate@v3

    - name: å¼€å§‹ç¼–è¯‘
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) || make -j1 V=s

    - name: æ•´ç†å›ºä»¶
      run: |
        mkdir -p release
        cp -rf openwrt/bin/targets/*/* release/

    - name: ä¸Šä¼  Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Firmware
        path: release

    - name: å‘å¸ƒåˆ° GitHub Releases
      uses: ncipollo/release-action@v1
      with:
        tag: OpenWrt-${{ github.run_number }}
        name: OpenWrt è‡ªåŠ¨ç¼–è¯‘ ${{ github.run_number }}
        body: |
          ğŸ¯ OpenWrt è‡ªåŠ¨æ„å»º
          - æºç ï¼š${{ github.event.inputs.SOURCE }}
          - æ„å»ºç¼–å·ï¼š${{ github.run_number }}
          - æ—¶é—´ï¼š${{ github.run_started_at }}
        artifacts: "release/**"
        token: ${{ secrets.GITHUB_TOKEN }}
